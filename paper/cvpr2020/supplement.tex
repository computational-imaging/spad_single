\documentclass[10pt,letterpaper]{article}

\usepackage{cvpr}
\usepackage{times}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}

% Include other packages here, before hyperref.
\usepackage{booktabs}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{array}
\usepackage{tabularx}
\usepackage{bm}
\usepackage{multirow}
\usepackage{float}
\usepackage[utf8x]{inputenc}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{algorithmicx}

\usepackage{dblfloatfix}

\input{mark_defs.tex}

% If you comment hyperref and then uncomment it, you should delete
% egpaper.aux before re-running latex.  (Or just hit 'q' on the first latex
% run, let it finish, and you should be clear).
\usepackage[breaklinks=true,bookmarks=false]{hyperref}

%\cvprfinalcopy % *** Uncomment this line for the final submission

\graphicspath{{"figures/"}{"G:/Shared drives/Stanford Computational
    Imaging/Projects/single_spad_depth/figures/"}{"H:/Shared drives/Stanford Computational
    Imaging/Projects/single_spad_depth/figures/"}{"/Users/gordon/mount/teamdrive/Shared
    drives/Stanford Computational Imaging/Projects/single_spad_depth/figures/"}
  {"/Volumes/GoogleDrive/Shared drives/Stanford Computational Imaging/Projects/single_spad_depth/figures/"}}

\def\cvprPaperID{2224} % *** Enter the CVPR Paper ID here
\def\httilde{\mbox{\tt\raisebox{-.5ex}{\symbol{126}}}}

% Pages are numbered in submission mode, and unnumbered in camera-ready
%\ifcvprfinal\pagestyle{empty}\fi
\setcounter{page}{4321}
\begin{document}

%%%%%%%%% TITLE
\title{Supplementary Information: Optimizing Monocular Depth Estimation with Global Depth Histogram
  Matching using a Single SPAD Transient}

\maketitle
\section{Ablation study on number of SID bins}
% \begin{itemize}
%   \item Simulation: 70, 140, 210, 280 bins
%   \item Captured: 70, 140, 210, 280 bins
% \end{itemize}
% Compare RMSE and runtime.
We conducted an ablation study on the effect of the number of SID bins
\cite{Fu2018} on both runtime and RMSE. We performed this analysis using SPAD
data with a signal-to-background (SBR) of 100, simulated on the test set of NYU
Depth v2. We used DenseDepth~\cite{Alhashim2018} for our MDE CNN.
Only the histogram matching portion was timed, not the CNN nor the
denoising pipeline.

\begin{figure}[H]
  \centering
  \begin{tabular}{c|cc}
    \toprule
    \# of sid bins & RMSE & Approx. Time/image (sec) \\
    \midrule
    70  & $0.351$ & $0.24$ \\
    140 & $0.346$ & $0.63$ \\
    210 & $0.345$ & $1.12$ \\
    280 & $0.345$ & $1.84$ \\
    \bottomrule
  \end{tabular}
  \caption{Effect of number of SID bins on RMSE and runtime. The marginal
    improvement in RMSE is offset by the increase in runtime as the number of
    bins grows.}
  \label{fig:sid_ablation}
\end{figure}


\section{Ablation study on effect of reflectance estimation}
We conducted an ablation study on whether the use of a reflectance
estimate has an impact on the runtime and quality of the solution.
We performed this analysis using SPAD
data with a signal-to-background (SBR) of 100, simulated on the test set of NYU
Depth v2 and using DenseDepth~\cite{Alhashim2018} for our MDE CNN.
Only the histogram matching portion was timed, not the CNN nor the denoising pipeline.

% \begin{itemize}
%   \item Intensity used to initialize histogram, not used to move pixels
%   \item Intensity used to initialize histogram and move pixels
%   \item Intensity not used to initialize histogram, used to move pixels
%   \item Intensity not used to initialize histogram, not used to move pixels
% \end{itemize}
% Compare RMSE and runtime.
\begin{figure}[H]
  \centering
  \begin{tabular}{c|c|cc}
    \toprule
    Intensity-weighted histogram & Intensity-aware pixel movement & Avg. RMSE & Approx. Time/image (sec) \\
    \midrule
    \multirow{2}{*}{Yes} & Yes & $0.346$ & $4.6$ \\
                         & No & $0.346$ & $0.6$ \\
    \midrule
    \multirow{2}{*}{No} & Yes & $0.444$ & $4.7$ \\
                        & No & $0.444$ & $0.6$ \\
    \bottomrule
  \end{tabular}
  \caption{Effect of reflectance modeling on RMSE and runtime. When the SPAD
    is simulated with the reflectance info but no reflectance estimate is used
    to generate a weighted histogram from the CNN depth map, the results are
    significantly worse. Furthermore, once the pixel movement matrix has been
    computed, the pixel movement procedure need not take
    into account the weights of the pixels being moved, since doing so provides no
    improvement and can take appreciably longer than a vectorized implementation
    that does not take pixel weights into account.}
\end{figure}

\section{A note on pixel shifting and dither artifacts}
We give pseudocode for our pixel shifting algorithm here. The pixels of the
image $I$ take depth bin values in $\set{0,\ldots,K-1}$. 
{ \footnotesize
  \begin{algorithm}[H]
    \caption{Move Pixels}
    \label{alg:move_pixels}
    \begin{algorithmic}
      \footnotesize \Procedure{MovePixels}{input image $I$ size $M \times N$,
        pixel movement matrix $T$ of size $K \times K$} \For{$k$ in $0,\ldots,
        K-1$} \State $p[k,:] \gets T[k,:]/\sum_{i=1}^K T[k,i]$ \EndFor \For{$m$
        in $1,\ldots,M$} \For{$n$ in $1,\ldots,N$} \State Sample $k'$ according
      to $p[I[m,n],:]$. \State $I[m,n] \gets k'$. \EndFor \EndFor \State
      \textbf{return} $I$ \EndProcedure
    \end{algorithmic}
  \end{algorithm}
} Because the pixel shifting process in Algorithm \ref{alg:move_pixels} contains
a sampling step, it is possible for
\textit{dither artifacts} to appear in the output image $I$, as shown in figure
\ref{fig:dither}. Specifically, when there are multiple possible output depth
bins for a given input depth bin, and a large region of equal depth in the input
image, the randomness in the pixel shifting algorithm will distribute the pixels
of large, equal-depth region in the input across the multiple possible output
depth bins in a random fashion.

\begin{figure}[H]
  \centering \includegraphics[width=0.66\textwidth]{dither.pdf}
  \caption{Example of dither artifacts. Sometimes, when our histogram matching
    is applied to images with large regions of similar depths, dither artifacts
    will occur.}
  \label{fig:dither}
\end{figure}


\section{Additional results on NYU Depth v2}
Figures \ref{fig:densedepth_1}--\ref{fig:midas_3} show additional results
for our method on the NYU Depth v2 dataset when the depth estimate is
initialized with the DenseDepth \cite{Alhashim2018} (Figures
\ref{fig:densedepth_1}--\ref{fig:densedepth_3}), DORN \cite{Fu2018} (Figures
\ref{fig:dorn_1}--\ref{fig:dorn_3}) 
and MiDaS \cite{Lasinger:2019} (Figures \ref{fig:midas_1} -- \ref{fig:midas_3}) monocular depth estimators.

We compare the output of the network $z_0$, the
median-rescaled network output (where the depth map $z_0$ is scaled pixel-wise by a
scalar $\frac{\text{median}(z_{GT})}{\text{median}(z_0)}$, $z_{GT}$ being the
ground truth depth map), the network output matched to the ground truth depth histogram, and the output of
our histogram matching method under a signal-to-background ratio (SBR) of 100.
We use the luminance of the RGB image as our reflectance map
for both SPAD simulation and histogram matching.
We show absolute difference maps and also give
the root-mean-square error (RMSE) for each example.
\input{sections/supplement/simulation_comparison.tex}

\section{Additional results for hardware prototype}
Figures \ref{fig:midas_captured_1}--\ref{fig:dorn_captured_3} show all the
captured results when the depth estimate is initialized with the MiDaS
\cite{Lasinger:2019} (Figures \ref{fig:midas_captured_1}--\ref{fig:midas_captured_3}),
DenseDepth (Figures \ref{fig:densedepth_captured_1}--\ref{fig:densedepth_captured_3}),
and DORN (Figures \ref{fig:dorn_captured_1}--\ref{fig:dorn_captured_3}). We compare
the output of the network $z_0$, the mean-rescaled network output where the
depth map $z_0$ has been scaled pixel-wise by the scalar
$\frac{\text{median}(h_{target})}{\text{median}(z_0)}$ ($h_{target}$ is the
processed SPAD transient), and the output of our method. As our laser is red, we
use the R channel of the RGB image as our reflectance map. We show absolute
difference maps and also give the root-mean-square-error (RMSE) for each
example.

Black pixels in the ground truth depth correspond to locations where our scanner
was unable to produce an accurate depth estimate (this can occur for a variety
of reasons including dark albedo and surface specularity). These pixels are masked off and not used in the RMSE
calculation, and appear as an absolute difference of 0 in the difference maps.
\input{sections/supplement/hardware_comparison.tex}

{\small
\bibliographystyle{ieeetr}
\bibliography{references}
}

\end{document}
